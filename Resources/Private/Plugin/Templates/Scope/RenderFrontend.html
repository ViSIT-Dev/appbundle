<html xmlns:f="http://typo3.org/ns/TYPO3/CMS/Fluid/ViewHelpers" data-namespace-typo3-fluid="true">

    <f:layout name="Fernrohr" />

    <f:section name="title">Titel Sektion</f:section>
    <f:section name="main">
        <style type="text/css">
            #scopeContainer #overlay{
                width: <f:format.raw>{config.maxxpx}</f:format.raw>px;
                height: <f:format.raw>{config.maxypx}</f:format.raw>px;
            }
            .poi.special{
                width: <f:format.raw>{config.specialIconSize}</f:format.raw>px;
                height: <f:format.raw>{config.specialIconSize}</f:format.raw>px;
            }
        </style>
        <f:comment>WHAT?! For some reason we need to address config via this to access it afterwards?</f:comment>
        <div class="full">
            <div id="scopeContainer">
                <video autoplay="true" id="camrtc" class="full"></video>
                <div id="overlay" class="full">
                    <div class="poi special" id="poi-impress">
                        <div class="inside">
                            <figure>
                                <f:if condition="{config.langicon_impress}">
                                    <f:then>
                                        <img class="poi-icon" src="{config.langicon_impress}" />
                                    </f:then>
                                    <f:else>
                                        <img class="poi-icon" src="/typo3/sysext/core/Resources/Public/Icons/Flags/PNG/GB.png" />
                                    </f:else>
                                </f:if>
                            </figure>
                        </div>
                    </div>
                    <div class="poi special" id="poi-lang-de">
                        <div class="inside">
                            <figure>
                                <f:if condition="{config.langicon_de}">
                                    <f:then>
                                        <img class="poi-icon" src="{config.langicon_de}" />
                                    </f:then>
                                    <f:else>
                                        <img class="poi-icon" src="/typo3/sysext/core/Resources/Public/Icons/Flags/PNG/DE.png" />
                                    </f:else>
                                </f:if>
                            </figure>
                        </div>
                    </div>
                    <div class="poi special" id="poi-lang-en">
                        <div class="inside">
                            <figure>
                                <f:if condition="{config.langicon_en}">
                                    <f:then>
                                        <img class="poi-icon" src="{config.langicon_en}" />
                                    </f:then>
                                    <f:else>
                                        <img class="poi-icon" src="/typo3/sysext/core/Resources/Public/Icons/Flags/PNG/GB.png" />
                                    </f:else>
                                </f:if>
                            </figure>
                        </div>
                    </div>
                    <f:for each="{pois}" as="poi">
                        <div class="poi lang-content {f:if(condition:'{poi.language} == 0', then:' lang-de', else:' lang-en')}" id="poi-{poi.uid}" style=height:{poi.radius}px;width:{poi.radius}px;">
                            <div class="inside">
                                <f:if condition="{config.debugmode}">
                                    <f:then>
                                        {poi.title}
                                        <br />X: {poi.x}
                                        <br />Y: {poi.y}
                                        <br />UID: {poi.uid}
                                        <br />FS: {poi.language}
                                    </f:then>
                                    <f:else>
                                        <figure>
                                            <img class="poi-icon" src="{config.poiicon}" />
                                        </figure>
                                    </f:else>
                                </f:if>
                            </div>
                        </div>
                    </f:for>
                </div>
                <f:if condition="{config.debugmode}">
                    <div id="debug">
                        <p>
                            maxx: {config.maxx}
                            <br />maxy: {config.maxy}
                            <br />maxxpx: {config.maxxpx}
                            <br />maxypx: {config.maxypx}
                            <br />icon: {config.poiicon}
                            <br />CurrentX: <span id="currentX"></span>
                            <br />CurrentY: <span id="currentY"></span>
                            <br />Target: <span id="target">-</span>
                        </p>
                        <h3>POIs</h3>
                        <table>
                            <tr>
                                <th>UID</th>
                                <th>Title</th>
                                <th>Radius</th>
                                <th>X</th>
                                <th>Y</th>
                                <th>Lang</th>
                            </tr>
                            <f:for each="{pois}" as="poi">
                                <tr>
                                    <td>{poi.uid}</td>
                                    <td>{poi.title}</td>
                                    <td>{poi.radius}</td>
                                    <td>{poi.x}</td>
                                    <td>{poi.y}</td>
                                    <td>{poi.language}</td>
                                </tr>
                            </f:for>
                        </table>
                    </div>
                </f:if>
                <div id="crosshair"></div>
                <div id="lang-indicator">
                    <figure class="lang-content lang-de">
                        <f:if condition="{config.langicon_de}">
                            <f:then>
                                <img class="poi-icon" src="{config.langicon_de}" />
                            </f:then>
                            <f:else>
                                <img class="poi-icon" src="/typo3/sysext/core/Resources/Public/Icons/Flags/PNG/DE.png" />
                            </f:else>
                        </f:if>
                    </figure>
                    <figure class="lang-content lang-en">
                        <f:if condition="{config.langicon_en}">
                            <f:then>
                                <img class="poi-icon" src="{config.langicon_en}" />
                            </f:then>
                            <f:else>
                                <img class="poi-icon" src="/typo3/sysext/core/Resources/Public/Icons/Flags/PNG/GB.png" />
                            </f:else>
                        </f:if>
                    </figure>
                </div>
            </div>
        </div>
        <div class="content-holder {f:if(condition:'{config.debugmode}', then:' debug')}">
            <div class="scroller">
                <div class="datapoint lang-de lang-en" id="datapoint-id-impress" data-id="impress" data-withBG="true" >
                    <h1 class="modal-title">Impressum</h1>
                    <p>
                        {imprint}
                        <div class="row imprint-logos">
                            <div class="col-3">
                                <img src="/typo3conf/ext/visit_tablets/Resources/Public/Backend/images/ViSIT_Logo_web.png"  class="img-fluid" />
                            </div>
                            <div class="col-6">
                                <img src="/typo3conf/ext/visit_tablets/Resources/Public/Backend/images/interreg.png"  class="img-fluid" />
                            </div>
                            <div class="col-3">
                                <img src="/typo3conf/ext/visit_tablets/Resources/Public/fh-kufstein.svg"  class="img-fluid" />
                            </div>
                        </div>
                    </p>
                </div>
                <f:for each="{pois}" as="datapoint">
                    <f:if condition="!{datapoint.fullscreenvideo}">
                        <div class="datapoint lang-content {f:if(condition:'{datapoint.language == 0}', then:' lang-de', else:' lang-en')}" id="datapoint-id-{datapoint.uid}" data-id="{datapoint.uid}" data-withBG="true" >
                            <h1 class="">{datapoint.title}</h1>

                            <h2 class="">{datapoint.subTitle}</h2>

                            <figure>
                                <f:render partial="RenderMedia" arguments="{media: datapoint.media}"/>
                            </figure>

                            <div class="desc-text">
                                <f:format.raw>
                                    {datapoint.description}
                                </f:format.raw>
                            </div>
                        </div>
                    </f:if>
                </f:for>
            </div>

            <div class="video-holder">
                <f:for each="{pois}" as="datapoint">
                    <f:if condition="{datapoint.fullscreenvideo}">
                        <div class="datapoint fullscreen transparent lang-content {f:if(condition:'{datapoint.language} == 0', then:' lang-de', else:' lang-en')}" id="datapoint-id-{datapoint.uid}" data-id="{datapoint.uid}" data-withBG="false" >
                            <f:render partial="RenderMedia" arguments="{media: datapoint.media}"/>
                        </div>
                    </f:if>
                </f:for>
            </div>
        </div>
        <script src="typo3conf/ext/visit_tablets/Resources/Public/Backend/vendors/encoder/jquery-2.1.4.min.js"></script> 
        <script src="typo3conf/ext/visit_tablets/Resources/Public/Backend/vendors/encoder/sha256.min.js"></script> 
        <script src="typo3conf/ext/visit_tablets/Resources/Public/Backend/vendors/encoder/phidget22.min.js"></script> 
        <script>

            //vars from be
            // const specialIconSize = {config.specialIconSize -> f:format.raw()};
            const specialIconSize = {config.specialIconSize};
            const specialIconX = {config.maxxpx - 540 - 50};
            const specialIconY = {config.maxypx - 960 - 50};
            const debugmode = {config.debugmode};

            const jsonPois = {jsonPois -> f:format.raw()};

            const xMax = {config.maxx};
            const yMax = {config.maxy};


            // calculating some special values for adjusting pois
            let specialIconSizeHalf = specialIconSize / 2;
            let specialIconOffset = specialIconSize * 1.7;

            // importing the WebCam Video stream
            const video = document.querySelector("#camrtc");
            
            if (navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({video: true})
                    .then(function (stream) {
                        video.srcObject = stream;
                    })
                    .catch(function (err0r) {
                        console.log("Something went wrong!\n" + err0r);
                        alert("No Webcam Detected!")
                    });
            }
            

            hysteresisFactor = 0.25;
            
            /**
             * getting pois from BE and adding special pois for language and impress
             */

            jsonPois.push({
                'uid': "impress",
                'x': specialIconX - specialIconSizeHalf,
                'y': specialIconY - specialIconSizeHalf,
                'radius': specialIconSize,
                'fullscreenvideo': 0,
                'displayAllways': true
            });
            jsonPois.push({
                'uid': "lang-de",
                'x': specialIconX - specialIconSizeHalf,
                'y': specialIconY - specialIconSizeHalf - specialIconOffset,
                'radius': specialIconSize,
                'lang':'de'
            });
            jsonPois.push({
                'uid': "lang-en",
                'x': specialIconX - specialIconSizeHalf,
                'y': specialIconY - specialIconSizeHalf - specialIconOffset * 2,
                'radius': specialIconSize,
                'lang':'en',
            });
            console.log(jsonPois);
            

            currentX = 0;
            currentY = 0;
            crosshairScreenOffsetX = 0;
            crosshairScreenOffsetY = 0;
            resetCrosshairPosition();
            language = "de";
            $("body").addClass("lang-de");
            
            var phid;

            $(document).ready(function () {

                // setup the pois
                for (var poi in jsonPois) {
                    console.log((jsonPois[poi]['y'] - jsonPois[poi]['radius'] / 2));
                    $("#poi-" + jsonPois[poi]["uid"])
                        .css({
                            'transform':
                                'translate(' + (jsonPois[poi]['y'] - jsonPois[poi]['radius'] / 2) + 'px' +
                                ',' + (jsonPois[poi]['x'] - jsonPois[poi]['radius'] / 2) + 'px' + ')'
                        });
                }


                // initializing the phidget connection and sensor inputs
                // <editor-fold defaultstate="collapsed" desc="phidget init">

                let socket = new WebSocket("ws://192.168.111.16:8765");

                socket.onopen = function (e) {
                    console.log("opened Connection");
                };
                const startValue = 34738; // most left / ccw
                const maxValue = 2**16-1; // see encoder settings within python settings
                socket.onmessage = function (e) {
                    let res = JSON.parse(e.data);
                    console.log("data received:", res);
                    if (res) {
                        let apos = res.pivot - startValue;
                        if ( apos < 0 ){
                            apos += maxValue;
                        }
                        console.log("APOS:" , apos);
                        //document.getElementById("tilt").innerHTML = res.tilt;
                        //document.getElementById("pivot").innerHTML = res.pivot;
                    }

                }
            });

            function posXChange(posChange, timeChange, indexTriggered) {
                currentX = Math.min(Math.max(currentX + posChange, 0), xMax);
                gotoPosition();
            }

            function posYChange(posChange, timeChange, indexTriggered) {
                currentY = Math.min(Math.max(currentY + posChange, 0), yMax);
                gotoPosition();
            }

            // </editor-fold>

            /**
             * ReCalculates the position of the Crosshair
             */
            function resetCrosshairPosition() {
                crosshairScreenOffsetX = $("#scopeContainer").width() / 2;
                crosshairScreenOffsetY = $("#scopeContainer").height() / 2;
            }

            /**
             * Checks if any POI is within range of Crosshair and displays contents
             */
            function getTarget() {
                for (var poi in jsonPois) {
                    distance = Math.sqrt(Math.pow((Math.abs(transformX) + crosshairScreenOffsetX - jsonPois[poi]["y"]), 2) + Math.pow((Math.abs(transformY) + crosshairScreenOffsetY - jsonPois[poi]["x"]), 2));
                    if (distance < jsonPois[poi]["radius"] / 2) {
                        $("#target").html(jsonPois[poi]["uid"]);
                        if (jsonPois[poi]["lang"]) {
                            $("body").removeClass("lang-en");
                            $("body").removeClass("lang-de");
                            $("body").addClass("lang-" + jsonPois[poi]["lang"]);
                            language = jsonPois[poi]["lang"];
                            return null;
                        }
                        if (
                            jsonPois[poi]["language"] != (language === "de" ? 0 : 1) && jsonPois[poi]["displayAllways"] != true
                        ) {
                            continue;
                        }
                        console.log({"target": $("#poi-" + jsonPois[poi]["uid"])});
                        return {
                            "language": jsonPois[poi]["language"],
                            "distanceFactor": 1 - (distance / (jsonPois[poi]["radius"] / 2)),
                            "target": $("#poi-" + jsonPois[poi]["uid"]),
                            "datapoint": $("#datapoint-id-" + jsonPois[poi]["uid"]),
                            "fullscreenvideo": jsonPois[poi]["fullscreenvideo"],
                            "displayAllways": jsonPois[poi]["displayAllways"]
                        };
                    }
                }
                $("#target").html("none");
            }

            /**
             * Function gets triggered by changes of sensors and changes display according to view change
             */
            function gotoPosition() {

                resetCrosshairPosition();

                mapYmax = $("#overlay").height() - $("#scopeContainer").height() * 1;
                mapXmax = $("#overlay").width() - $("#scopeContainer").width() * 1;

                transformY = (currentY / yMax * mapYmax * -1);
                transformX = (currentX / xMax * mapXmax * -1);

                $("#overlay").css({
                    'transform': 'translate(' + transformX + 'px,' + transformY + 'px)'
                });

                var target = getTarget();
                if (target) {
                    // to have a smoother experiance this is the hysterese
                    if (target["distanceFactor"] > hysteresisFactor) {
                        if (!target["target"].hasClass("active")) {
                            target["target"].addClass("active");
                            target["datapoint"].addClass("active");
                            $(".content-holder").addClass("active");

                            if (target["fullscreenvideo"] == 0) {
                                $(".scroller").addClass("active");
                            }

                            // start video
                            target["datapoint"].find("video").each(function (i, video) {
                                $(video)[0].autoplay = true;
                                $(video)[0].controls = false;
                                $(video)[0].loop = true;
                                $(video)[0].play();
                            });
                        }
                    }
                } else {
                    $(".poi.active").removeClass("active");
                    $(".datapoint.active").removeClass("active");
                    $(".content-holder").removeClass("active");
                    $(".scroller").removeClass("active");

                    // stop video
                    $(".content-holder video").each(function (i, video) {
                        $(video)[0].pause();
                        $(video)[0].currentTime = 0;
                    });

                }

                if (debugmode) {
                    $("#currentY").html(Math.abs(transformX) + crosshairScreenOffsetX);
                    $("#currentX").html(Math.abs(transformY) + crosshairScreenOffsetY);
                }
            }

        </script>
    </f:section>
</html>
